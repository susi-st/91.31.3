<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>9ä¸Š3-1.3ä½œæ¥­ç³»çµ±èª²å¾Œç¸½è¤‡ç¿’</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --macaron-pink: #FFB7B2;
            --macaron-orange: #FFDAC1;
            --macaron-yellow: #FFF9B1;
            --macaron-green: #B5EAD7;
            --macaron-blue: #C7CEEA;
            --macaron-purple: #E0BBE4;
            --macaron-mint: #E2F0CB;
        }

        body {
            font-family: 'Fredoka', 'Noto Sans TC', sans-serif;
            background-color: #fce7f3;
            overflow-x: hidden;
        }

        .main-card {
            max-width: 1000px;
            min-height: 85vh;
            border-radius: 30px;
            box-shadow: 0 20px 50px rgba(236, 72, 153, 0.1);
        }

        .macaron-btn {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: grab;
        }

        .macaron-btn:active {
            cursor: grabbing;
            transform: scale(0.95);
        }

        .slot {
            transition: all 0.3s ease;
            min-height: 4.5rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            background: white;
            border: 2px dashed rgba(0, 0, 0, 0.08);
            font-weight: bold;
            position: relative;
        }

        .slot.drag-over {
            background: rgba(244, 114, 182, 0.05);
            border-color: #ec4899;
        }

        /* åœ–ç‰‡ä¸Šå‚³æ¡†æ¨£å¼ */
        .upload-box {
            aspect-ratio: 16 / 10;
            border: 3px dashed #e5e7eb;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #f9fafb;
            cursor: pointer;
            transition: all 0.3s;
            overflow: hidden;
            position: relative;
            outline: none;
        }
        .upload-box:hover, .upload-box:focus { border-color: var(--macaron-pink); background-color: #fff1f2; }
        .upload-box img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .upload-label { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.5); color: white; text-align: center; font-size: 0.8rem; padding: 4px; pointer-events: none; }

        /* é¡è‰²é¡åˆ¥ */
        .color-0 { background-color: var(--macaron-pink); }
        .color-1 { background-color: var(--macaron-orange); }
        .color-2 { background-color: var(--macaron-yellow); }
        .color-3 { background-color: var(--macaron-green); }
        .color-4 { background-color: var(--macaron-blue); }
        .color-5 { background-color: var(--macaron-purple); }
        .color-6 { background-color: var(--macaron-mint); }
        
        .depth-0 { background-color: #6366f1; color: white; }
        .depth-1 { background-color: #818cf8; color: white; }
        .depth-2 { background-color: #a5b4fc; color: #1e1b4b; }
        .depth-3 { background-color: #fbbf24; color: #78350f; }

        .fixed-block { background-color: #f3f4f6; border: 2px solid #e5e7eb; }

        .correct-hint { border: 6px solid #4ade80 !important; }
        .error-hint { border: 6px solid #f87171 !important; }

        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .progress-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.4s ease;
            background-color: white;
            border: 2px solid #e5e7eb;
            color: #9ca3af;
        }
        .progress-circle.passed {
            background-color: #22c55e;
            border-color: #22c55e;
            color: white;
            box-shadow: 0 4px 10px rgba(34, 197, 94, 0.2);
        }

        #pw-input {
            letter-spacing: 0.5rem;
            text-align: center;
            font-size: 1.5rem;
        }

        /* å¼·åŒ–æ€¥æ•‘åŒ…é»æ“Šç‹€æ…‹æ§åˆ¶ */
        .aid-kit-enabled {
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        .aid-kit-disabled {
            opacity: 0.2 !important;
            pointer-events: none !important;
        }
        .first-aid {
            display: inline-block;
            cursor: pointer;
            padding: 8px; 
            position: relative;
            z-index: 150;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="quiz-app" class="main-card bg-white w-full flex flex-col relative overflow-hidden">
        
        <!-- ä¸Šæ–¹æ¨™é¡Œåˆ— -->
        <header class="p-6 md:p-8 flex flex-wrap gap-4 justify-between items-center bg-pink-50/50">
            <div class="flex flex-col">
                <div class="flex items-center flex-wrap gap-4">
                    <h1 class="text-2xl md:text-3xl font-bold text-pink-500 text-balance">âœ¨ ä½œæ¥­ç³»çµ±èª²å¾Œç¸½è¤‡ç¿’</h1>
                    <div id="status-indicators" class="flex gap-2 ml-2">
                        <!-- ç‡ˆè™Ÿç”± JS å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
                <p class="text-gray-400 text-sm mt-1">ä½œç­”é€²åº¦: <span id="progress-text" class="font-bold text-indigo-400"></span></p>
            </div>
            
            <div id="timer" class="text-xl font-bold text-gray-600 bg-white px-4 py-1 rounded-full shadow-sm">00:00</div>
        </header>

        <!-- ä¸»å…§å®¹å€ -->
        <main id="question-container" class="flex-grow p-6 md:p-10 overflow-y-auto">
            <!-- é¡Œç›® JS æ³¨å…¥ -->
        </main>

        <!-- ä¸‹æ–¹å°è¦½åˆ— -->
        <footer class="p-6 md:p-8 bg-gray-50 flex flex-wrap gap-4 justify-between items-center relative z-[200]">
            <button id="prev-btn" class="px-6 py-2 rounded-full border-2 border-pink-200 text-pink-400 font-bold hover:bg-pink-100 disabled:opacity-30 transition-all">
                ä¸Šä¸€é¡Œ
            </button>
            
            <div class="flex items-center gap-6">
                <!-- æ€¥æ•‘åŒ…å€åŸŸ -->
                <div id="aid-kit" class="flex gap-1 text-2xl border-r-2 border-gray-200 pr-2 mr-1 aid-kit-enabled transition-all duration-300">
                    <span class="first-aid" title="æ€¥æ•‘åŒ…">ğŸš‘</span>
                    <span class="first-aid" title="æ€¥æ•‘åŒ…">ğŸš‘</span>
                </div>

                <div class="flex gap-4">
                    <button id="check-btn" class="px-8 py-3 bg-pink-500 text-white rounded-full font-bold shadow-lg shadow-pink-200 hover:bg-pink-600 transition-all active:scale-95">
                        æª¢æŸ¥ç­”æ¡ˆ
                    </button>
                    <button id="next-btn" class="px-6 py-2 rounded-full bg-indigo-400 text-white font-bold hover:bg-indigo-500 transition-all shadow-lg shadow-indigo-100 disabled:bg-gray-300 disabled:shadow-none disabled:cursor-not-allowed">
                        ä¸‹ä¸€é¡Œ
                    </button>
                </div>
            </div>
        </footer>

        <!-- è‡ªå®šç¾©æé†’å½ˆçª— -->
        <div id="modal-overlay" class="fixed inset-0 bg-black/40 z-[300] flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300">
            <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl transform scale-90 transition-transform duration-300" id="modal-content">
                <div class="text-4xl mb-4 text-center">ğŸ’¡</div>
                <h3 id="modal-title" class="text-xl font-bold text-gray-800 text-center mb-2">æº«é¦¨æé†’</h3>
                <p id="modal-message" class="text-gray-600 text-center mb-6 leading-relaxed"></p>
                <div class="flex gap-4 justify-center">
                    <button onclick="closeModal()" class="px-6 py-2 border-2 border-gray-200 text-gray-400 font-bold rounded-full hover:bg-gray-50 transition-all active:scale-95">
                        è¿”å›
                    </button>
                    <button id="modal-confirm-btn" class="px-6 py-2 bg-indigo-500 text-white font-bold rounded-full hover:bg-indigo-600 transition-all active:scale-95 shadow-lg shadow-indigo-100">
                        å‰å¾€ä¸‹ä¸€é¡Œ
                    </button>
                </div>
            </div>
        </div>

        <!-- å¯†ç¢¼è¼¸å…¥å½ˆçª— -->
        <div id="pw-modal-overlay" class="fixed inset-0 bg-black/60 z-[400] flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300">
            <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl transform scale-90 transition-transform duration-300" id="pw-modal-content">
                <div class="text-4xl mb-4 text-center">ğŸ”’</div>
                <h3 class="text-xl font-bold text-gray-800 text-center mb-4">è«‹è¼¸å…¥é€²å…¥å¯†ç¢¼</h3>
                <input type="password" id="pw-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full p-4 border-2 border-pink-100 rounded-2xl mb-6 focus:border-pink-300 outline-none transition-all">
                <div class="flex gap-4 justify-center">
                    <button onclick="closePwModal()" class="px-6 py-2 border-2 border-gray-200 text-gray-400 font-bold rounded-full hover:bg-gray-50 transition-all active:scale-95">
                        å–æ¶ˆ
                    </button>
                    <button id="pw-confirm-btn" class="px-8 py-2 bg-pink-500 text-white font-bold rounded-full hover:bg-pink-600 transition-all active:scale-95 shadow-lg">
                        ç¢ºèªé€²å…¥
                    </button>
                </div>
            </div>
        </div>

        <!-- çµç®—é é¢ Overlay -->
        <div id="result-overlay" class="absolute inset-0 bg-white z-[500] flex flex-col items-center justify-center p-6 md:p-10 hidden fade-in overflow-y-auto">
            <div class="border-4 border-pink-200 rounded-3xl p-8 max-w-3xl w-full bg-white shadow-xl my-8">
                <h2 class="text-3xl font-bold text-pink-500 mb-4 text-center text-balance">ğŸ“ ä½œç­”çµæœ</h2>
                
                <div class="text-center mb-4"><span class="text-sm font-bold text-gray-400">ã€ å¯¦ä½œç•«é¢è¤‡æŸ¥ ã€‘</span></div>
                <div id="summary-screenshots" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-8 text-center">
                </div>

                <div id="final-stats" class="space-y-4 mb-8"></div>

                <div class="bg-indigo-50 p-6 rounded-2xl mb-8 text-center border border-indigo-100">
                    <div id="quote-zh" class="text-xl font-bold text-indigo-600 mb-3 text-balance"></div>
                    <div id="quote-en" class="text-base italic text-indigo-400 leading-relaxed text-balance"></div>
                </div>

                <div class="flex justify-center">
                    <button onclick="restartQuiz()" class="px-12 py-4 bg-pink-500 text-white rounded-full text-xl font-bold shadow-xl hover:bg-pink-600 transition-all active:scale-95">
                        é‡æ–°ä½œç­”æ¸¬é©—é¡Œ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 px-8 py-4 rounded-full bg-gray-800 text-white font-bold opacity-0 transition-opacity pointer-events-none z-[600] text-xl shadow-lg"></div>

    <script>
        const quizData = [
            {
                type: 'image_upload',
                question: "è«‹å®Œæˆä»¥ä¸‹å››é …ä½œæ¥­ç³»çµ±å¯¦ä½œï¼Œä¸¦é»æ“Šæ–¹æ¡†ä¸Šå‚³ï¼Œæˆ–æŒ‰å³éµ/Ctrl+V è²¼ä¸Šæˆªåœ–ï¼š",
                labels: ["ç£ç¢Ÿæœ€ä½³åŒ–", "ç§»é™¤ç¨‹å¼", "è‡ªå‹•æ›´æ–°Update", "é–‹å•Ÿé˜²ç«ç‰†"]
            },
            {
                type: 'drag_and_drop',
                question: "ã€Œä½œæ¥­ç³»çµ±ã€å¦‚åŒé›»è…¦çš„ç®¡å®¶ï¼Œä¸åªè¦å”èª¿é›»è…¦ç¡¬é«”èˆ‡ [__] ä¹‹é–“çš„ [__]ï¼Œä¹Ÿæ˜¯é›»è…¦èˆ‡ [__] ä¹‹é–“çš„ [__]ã€‚",
                blanks: ["è»Ÿé«”", "è³‡æºåˆ†é…", "ä½¿ç”¨è€…", "æºé€šä»‹é¢"],
                options: ["è»Ÿé«”", "è³‡æºåˆ†é…", "ä½¿ç”¨è€…", "æºé€šä»‹é¢"] 
            },
            {
                type: 'matching_fixed',
                question: "è«‹æ ¹æ“šä¸‹æ–¹çš„è§’è‰²èªªæ˜ï¼Œè£œé½Šä¸­é–“æ¼æ‰çš„ç©ºæ ¼ï¼š",
                options: ["æ‡‰ç”¨è»Ÿé«”", "ä½œæ¥­ç³»çµ±"],
                steps: [
                    { type: 'fixed', name: "ä½¿ç”¨è€…", desc: "ä½ /æˆ‘/ä»–(å¥¹)" },
                    { type: 'slot', answer: "æ‡‰ç”¨è»Ÿé«”", desc: "ä½¿ç”¨è€…æœ€å¸¸æ“ä½œçš„è»Ÿé«”(å°‘äº†å®ƒï¼Œæ‰‹æ©Ÿå°±ä¸å¥½ç©äº†)" },
                    { type: 'slot', answer: "ä½œæ¥­ç³»çµ±", desc: "å±…ä¸­å”èª¿è»Ÿç¡¬é«”è³‡æºèˆ‡å·¥ä½œçš„è»Ÿé«”(å°‘äº†å®ƒï¼Œåªèƒ½ç©é–‹é—œæ©Ÿ)" },
                    { type: 'fixed', name: "ç¡¬é«”", desc: "é›»è…¦/æ‰‹æ©Ÿ/å¹³æ¿" }
                ]
            },
            {
                type: 'matching_list',
                question: "è«‹å°‡ä¸‹æ–¹çš„å››ç¨®ç¨‹å¼æˆ–è»Ÿé«”é€²è¡Œæ­£ç¢ºçš„åˆ†é¡ï¼š",
                options: ["Windows10", "ç£ç¢Ÿæ¸…ç†å·¥å…·", "ç·¨è­¯ç¨‹å¼", "ç°¡å ±è»Ÿé«”"],
                items: [
                    { label: "ç³»çµ±è»Ÿé«”â”€ä½œæ¥­ç³»çµ±", answer: "Windows10" },
                    { label: "ç³»çµ±è»Ÿé«”â”€ç³»çµ±å·¥å…·ç¨‹å¼", answer: "ç£ç¢Ÿæ¸…ç†å·¥å…·" },
                    { label: "ç³»çµ±è»Ÿé«”â”€è»Ÿé«”é–‹ç™¼å·¥å…·", answer: "ç·¨è­¯ç¨‹å¼" },
                    { label: "æ‡‰ç”¨è»Ÿé«”", answer: "ç°¡å ±è»Ÿé«”" }
                ]
            },
            {
                type: 'matching_list',
                question: "è«‹å°‡ä¸‹æ–¹çš„ä¸‰ç¨®ä½œæ¥­ç³»çµ±èˆ‡å®ƒçš„ç‰¹è‰²é€²è¡Œæ­é…ï¼š",
                options: ["Windows", "macOS", "Linux"],
                items: [
                    { label: "æ¶æ§‹è¼ƒé–‹æ”¾ï¼Œå¸‚ä½”ç‡æœ€é«˜", answer: "Windows" },
                    { label: "è»Ÿç¡¬é«”ç’°å¢ƒè¼ƒå°é–‰ï¼Œå¼·èª¿ç¾å­¸è¨­è¨ˆ", answer: "macOS" },
                    { label: "è‡ªç”±è»Ÿé«”ã€é–‹æ”¾åŸå§‹ç¢¼", answer: "Linux" }
                ]
            },
            {
                type: 'matching_list',
                question: "è«‹é‡å°ä½œæ¥­ç³»çµ±ç‰ˆæœ¬èˆ‡å„éšæ®µçš„ä»‹é¢åŠŸèƒ½é€²è¡Œé…å°ï¼š",
                options: ["MS-DOS", "Windows95", "Windows10", "èªéŸ³åŠ©ç†"],
                items: [
                    { label: "å‘½ä»¤è¡Œä»‹é¢ (16bits)", answer: "MS-DOS" },
                    { label: "åœ–å½¢ä½¿ç”¨è€…ä»‹é¢ (16/32bits)", answer: "Windows95" },
                    { label: "åœ–å½¢ä½¿ç”¨è€…ä»‹é¢ (64bits)", answer: "Windows10" },
                    { label: "æ–°ä¸€ä»£ä½œæ¥­ç³»çµ±æ·»åŠ çš„åŠŸèƒ½", answer: "èªéŸ³åŠ©ç†" }
                ]
            }
        ];

        const inspirationalQuotes = [
            { en: "Genius is one percent inspiration and ninety-nine percent perspiration.", zh: "å¤©æ‰å°±æ˜¯ç™¾åˆ†ä¹‹ä¸€çš„éˆæ„ŸåŠ ä¸Šç™¾åˆ†ä¹‹ä¹åä¹çš„æ±—æ°´ã€‚ â€” æ„›è¿ªç”Ÿ" },
            { en: "Success is not final, failure is not fatal.", zh: "æˆåŠŸä¸æ˜¯çµ‚é»ï¼Œå¤±æ•—ä¹Ÿä¸æ˜¯çµ‚çµï¼šå”¯æœ‰å‹‡æ•¢å‰è¡Œçš„å‹‡æ°£æ‰æ˜¯æœ€é‡è¦çš„ã€‚ â€” é‚±å‰çˆ¾" },
            { en: "Believe you can and you're halfway there.", zh: "ç›¸ä¿¡ä½ è‡ªå·±èƒ½åšåˆ°ï¼Œä½ å°±å·²ç¶“æˆåŠŸäº†ä¸€åŠã€‚ â€” ç¾…æ–¯ç¦" },
            { en: "Stay hungry, stay foolish.", zh: "æ±‚çŸ¥è‹¥æ¸´ï¼Œè™›å¿ƒè‹¥æ„šã€‚ â€” è³ˆä¼¯æ–¯" },
            { en: "Imagination is more important than knowledge.", zh: "æƒ³åƒåŠ›æ¯”çŸ¥è­˜æ›´é‡è¦ã€‚ â€” æ„›å› æ–¯å¦" },
            { en: "Action is the foundational key to all success.", zh: "è¡Œå‹•æ˜¯æ‰€æœ‰æˆåŠŸçš„åŸºçŸ³. â€” ç•¢å¡ç´¢" },
            { en: "The best way to predict the future is to create it.", zh: "é æ¸¬æœªä¾†çš„æœ€ä½³æ–¹å¼å°±æ˜¯å»å‰µé€ å®ƒã€‚ â€” å½¼å¾—Â·æœæ‹‰å…‹" }
        ];

        const SECRET_PASS = "3939889";
        let currentIdx = 0;
        let userStates = {};
        let quizCheckedStatus = {}; 
        let quizPassedStatus = {}; 
        let firstAidCount = 2; 
        let totalAttempts = 0; 
        let startTime = Date.now();
        let timerInterval = null;
        let isTimerStarted = false; 

        window.onload = () => {
            initIndicators();
            renderQuestion();
            setupGlobalEvents();
        };

        function initIndicators() {
            const container = document.getElementById('status-indicators');
            container.innerHTML = quizData.map((_, i) => `<div class="progress-circle" data-idx="${i}">${i+1}</div>`).join('');
        }

        function setupGlobalEvents() {
            document.getElementById('next-btn').onclick = () => navigate(1);
            document.getElementById('prev-btn').onclick = () => navigate(-1);
            document.getElementById('check-btn').onclick = checkAnswer;
            
            // é‡æ–°ç¶å®šæ€¥æ•‘åŒ…é»æ“Šäº‹ä»¶
            const aidSpans = document.querySelectorAll('.first-aid');
            aidSpans.forEach((span) => {
                span.onclick = (e) => {
                    e.stopPropagation();
                    useFirstAid(span);
                };
            });

            document.getElementById('pw-confirm-btn').onclick = verifyPassword;
            document.getElementById('pw-input').onkeypress = (e) => { if(e.key === 'Enter') verifyPassword(); };
        }

        function startTimer() {
            if (isTimerStarted) return;
            isTimerStarted = true;
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const mins = String(Math.floor(elapsed / 60)).padStart(2, '0');
                const secs = String(elapsed % 60).padStart(2, '0');
                const timerEl = document.getElementById('timer');
                if (timerEl) timerEl.innerText = `${mins}:${secs}`;
            }, 1000);
        }

        function showCustomModal(title, message, confirmText, onConfirm) {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            const btn = document.getElementById('modal-confirm-btn');
            btn.innerText = confirmText;
            btn.onclick = () => { closeModal(); if (onConfirm) onConfirm(); };
            overlay.classList.remove('hidden');
            setTimeout(() => { overlay.classList.remove('opacity-0'); content.classList.remove('scale-90'); }, 10);
        }

        function closeModal() {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            overlay.classList.add('opacity-0'); content.classList.add('scale-90');
            setTimeout(() => overlay.classList.add('hidden'), 300);
        }

        function showPwModal(callback) {
            const overlay = document.getElementById('pw-modal-overlay');
            const content = document.getElementById('pw-modal-content');
            const input = document.getElementById('pw-input');
            input.value = "";
            window.pwCallback = callback;
            overlay.classList.remove('hidden');
            setTimeout(() => { overlay.classList.remove('opacity-0'); content.classList.remove('scale-90'); input.focus(); }, 10);
        }

        function closePwModal() {
            const overlay = document.getElementById('pw-modal-overlay');
            const content = document.getElementById('pw-modal-content');
            overlay.classList.add('opacity-0'); content.classList.add('scale-90');
            setTimeout(() => overlay.classList.add('hidden'), 300);
        }

        function verifyPassword() {
            const input = document.getElementById('pw-input').value;
            if (input === SECRET_PASS) { 
                closePwModal(); 
                if(window.pwCallback) {
                    window.pwCallback(); 
                    startTimer(); 
                }
            } else {
                showToast("å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥å–”ï¼", "error");
                document.getElementById('pw-input').value = "";
            }
        }

        function renderQuestion() {
            const container = document.getElementById('question-container');
            const q = quizData[currentIdx];
            const progressEl = document.getElementById('progress-text');
            const nextBtn = document.getElementById('next-btn');
            const aidKit = document.getElementById('aid-kit');

            if (progressEl) progressEl.innerText = `${currentIdx + 1} / ${quizData.length}`;
            document.getElementById('prev-btn').disabled = (currentIdx === 0);
            nextBtn.innerText = (currentIdx === quizData.length - 1) ? "æŸ¥çœ‹çµæœ" : "ä¸‹ä¸€é¡Œ";
            
            nextBtn.disabled = (currentIdx === 0 && !quizPassedStatus[0]);

            // æŒ‡ä»¤ï¼šæ€¥æ•‘åŒ…åœ¨åŒ…å«ç¬¬ä¸€é¡Œåœ¨å…§çš„æ‰€æœ‰é¡Œç›®éƒ½æ‡‰ç”Ÿæ•ˆ
            aidKit.classList.remove('aid-kit-disabled');
            aidKit.classList.add('aid-kit-enabled');
            
            // ç¢ºä¿æ‰€æœ‰æœªæ¶ˆè€—çš„åœ–ç¤ºé‡è¨­å¯é»æ“Šå±¬æ€§
            document.querySelectorAll('.first-aid').forEach(span => {
                if (span.style.opacity !== "0.2") {
                    span.style.pointerEvents = "auto";
                    span.style.cursor = "pointer";
                }
            });

            container.innerHTML = '';
            const wrapper = document.createElement('div');
            wrapper.className = 'fade-in';

            if (q.type === 'image_upload') renderImageUpload(q, wrapper);
            else if (q.type === 'drag_and_drop') renderDragAndDrop(q, wrapper);
            else if (q.type === 'matching_fixed') renderMatchingFixed(q, wrapper);
            else if (q.type === 'matching_list') renderMatchingList(q, wrapper);

            container.appendChild(wrapper);
            restoreCurrentQuestionState();
            updateProgressIndicators();
        }

        function renderImageUpload(q, wrapper) {
            const title = document.createElement('h3');
            title.className = "text-2xl text-gray-700 font-bold mb-8 text-balance text-center";
            title.innerText = q.question;
            wrapper.appendChild(title);
            const grid = document.createElement('div');
            grid.className = "grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto pb-8";
            q.labels.forEach((label, i) => {
                const itemBox = document.createElement('div');
                itemBox.className = "flex flex-col gap-2";
                const tag = document.createElement('div');
                tag.className = "self-center px-4 py-1 bg-pink-400 text-white rounded-full text-sm font-bold shadow-sm mb-1";
                tag.innerText = `âœ¨ ${label}`;
                const box = document.createElement('div');
                box.className = "upload-box shadow-sm";
                box.id = `upload-${i}`;
                box.contentEditable = "true";
                box.innerHTML = `<div class="flex flex-col items-center p-4"><span class="text-4xl mb-2 text-gray-300">ğŸ“¸</span><span class="text-xs text-gray-400">é»æ“Šä¸Šå‚³æˆ–å³éµè²¼ä¸Š</span></div>`;
                box.onclick = (e) => { if (e.target === box || box.contains(e.target)) { const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*'; input.onchange = (ev) => handleImage(ev.target.files[0], box, i); input.click(); } };
                box.onkeydown = (e) => { if (!(e.ctrlKey && e.key === 'v') && !(e.metaKey && e.key === 'v')) e.preventDefault(); };
                box.onpaste = (e) => { e.preventDefault(); const items = (e.clipboardData || e.originalEvent.clipboardData).items; for (let index in items) { const item = items[index]; if (item.kind === 'file' && item.type.indexOf("image") !== -1) handleImage(item.getAsFile(), box, i); } };
                itemBox.appendChild(tag);
                itemBox.appendChild(box);
                grid.appendChild(itemBox);
            });
            wrapper.appendChild(grid);
        }

        function handleImage(file, box, index) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { 
                box.innerHTML = `<img src="${e.target.result}" alt="screenshot"><div class="upload-label">${quizData[0].labels[index]}</div>`; 
                saveCurrentQuestionState(); 
            };
            reader.readAsDataURL(file);
        }

        function renderDragAndDrop(q, wrapper) {
            const title = document.createElement('h3');
            title.className = "text-2xl text-gray-700 font-bold mb-8 leading-relaxed text-balance";
            const parts = q.question.split('[__]');
            parts.forEach((part, i) => {
                const textSpan = document.createElement('span'); textSpan.innerText = part; title.appendChild(textSpan);
                if (i < parts.length - 1) {
                    const slot = createSlot(i, q.blanks[i]);
                    slot.style.minWidth = `${q.blanks[i].length * 2.2 + 4}rem`;
                    slot.classList.add('text-2xl', 'text-center');
                    title.appendChild(slot);
                }
            });
            wrapper.appendChild(title);
            renderSourceArea(q.options, wrapper);
        }

        function renderMatchingFixed(q, wrapper) {
            const title = document.createElement('h3'); title.className = "text-2xl text-gray-700 font-bold mb-10 text-center text-balance";
            title.innerText = q.question; wrapper.appendChild(title);
            const flow = document.createElement('div'); flow.className = "grid grid-cols-1 md:grid-cols-4 gap-4 items-start";
            q.steps.forEach((step, idx) => {
                const item = document.createElement('div'); item.className = "flex flex-col items-center text-center";
                const desc = document.createElement('p'); desc.className = "text-xl text-gray-600 mb-4 h-20 flex items-center justify-center px-2 font-bold leading-tight text-balance";
                desc.innerText = step.desc; item.appendChild(desc);
                if (step.type === 'fixed') {
                    const fixed = document.createElement('div'); fixed.className = "fixed-block w-full py-5 rounded-xl font-bold text-gray-500 shadow-sm text-2xl bg-gray-50";
                    fixed.innerText = step.name; item.appendChild(fixed);
                } else {
                    const slot = createSlot(idx, step.answer); slot.className += " w-full rounded-xl py-6 border-2 text-3xl text-center bg-white";
                    item.appendChild(slot);
                }
                flow.appendChild(item);
            });
            wrapper.appendChild(flow);
            renderSourceArea(q.options, wrapper);
        }

        function renderMatchingList(q, wrapper) {
            const title = document.createElement('h3'); title.className = "text-2xl text-gray-700 font-bold mb-10 text-center text-balance";
            title.innerText = q.question; wrapper.appendChild(title);
            const list = document.createElement('div'); list.className = "grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto";
            const itemColors = [];
            q.items.forEach((item, idx) => {
                const itemBox = document.createElement('div');
                let colorIdx;
                if (currentIdx === 3) { itemBox.className = `p-6 rounded-3xl border-2 border-white shadow-sm flex flex-col gap-5 transition-all depth-${idx}`; itemColors.push(`depth-${idx}`); } 
                else if (currentIdx === 5) { const dist = [0, 2, 4, 5]; colorIdx = dist[idx]; itemBox.className = `p-6 rounded-3xl border-2 border-white shadow-sm flex flex-col gap-5 transition-all color-${colorIdx}`; itemColors.push(colorIdx); } 
                else { colorIdx = idx % 7; itemBox.className = `p-6 rounded-3xl border-2 border-white shadow-sm flex flex-col gap-5 transition-all color-${colorIdx}`; itemColors.push(colorIdx); }
                const label = document.createElement('div'); label.className = "text-2xl font-black tracking-wider text-center drop-shadow-sm text-balance";
                label.innerText = item.label; itemBox.appendChild(label);
                const slot = createSlot(idx, item.answer); slot.className += ` w-full rounded-2xl py-6 border-2 dashed text-3xl text-center text-gray-700 bg-white/90`;
                itemBox.appendChild(slot); list.appendChild(itemBox);
            });
            wrapper.appendChild(list);
            renderSourceArea(q.options, wrapper, itemColors);
        }

        function createSlot(index, answer) {
            const slot = document.createElement('div');
            slot.className = `slot border-b-2 border-gray-300 mx-2 rounded-lg align-bottom`;
            slot.dataset.type = "slot"; slot.dataset.index = index; slot.dataset.answer = answer;
            slot.ondragover = (e) => allowDrop(e, slot);
            slot.ondragleave = () => slot.classList.remove('drag-over');
            slot.ondrop = (e) => handleDrop(e, slot);
            return slot;
        }

        function renderSourceArea(options, wrapper, excludeColors = []) {
            const sourceArea = document.createElement('div');
            sourceArea.className = "mt-16 p-8 bg-pink-50/30 rounded-3xl border-2 border-dashed border-pink-100 flex flex-wrap justify-center gap-6 min-h-[120px]";
            sourceArea.id = "source-area"; sourceArea.dataset.type = "source";
            sourceArea.ondragover = (e) => allowDrop(e, sourceArea);
            sourceArea.ondrop = (e) => handleDrop(e, sourceArea);
            const shuffled = [...options].sort(() => Math.random() - 0.5);
            let colorPool = [0, 1, 2, 3, 4, 5, 6].sort(() => Math.random() - 0.5);
            shuffled.forEach((opt, idx) => {
                const currentPool = colorPool.filter(c => !excludeColors.includes(c));
                const finalPool = currentPool.length > 0 ? currentPool : colorPool;
                const colorIdx = finalPool[idx % finalPool.length];
                sourceArea.appendChild(createDragElement(opt, idx, colorIdx));
            });
            wrapper.appendChild(sourceArea);
        }

        function createDragElement(text, idSuffix, colorIdx) {
            const el = document.createElement('div');
            el.className = `macaron-btn color-${colorIdx} px-8 py-3 rounded-2xl shadow-md font-bold text-gray-700 border-2 border-white/50 text-2xl whitespace-nowrap z-10`;
            el.innerText = text; el.id = `opt-${currentIdx}-${idSuffix}-${Math.random().toString(36).substr(2, 5)}`;
            el.draggable = true; el.dataset.value = text;
            el.ondragstart = (e) => { e.dataTransfer.setData("text/plain", el.id); el.style.opacity = "0.5"; };
            el.ondragend = () => el.style.opacity = "1";
            return el;
        }

        function allowDrop(e, target) { e.preventDefault(); target.classList.add('drag-over'); }

        function handleDrop(e, target) {
            e.preventDefault(); target.classList.remove('drag-over');
            const elId = e.dataTransfer.getData("text/plain"); const el = document.getElementById(elId);
            if (!el) return;
            if (target.dataset.type === "slot") {
                const existing = target.querySelector('.macaron-btn');
                if (existing) document.getElementById('source-area').appendChild(existing);
                target.appendChild(el);
            } else if (target.dataset.type === "source") { target.appendChild(el); }
            saveCurrentQuestionState();
        }

        function saveCurrentQuestionState() {
            const q = quizData[currentIdx];
            const state = { values: {} };
            if (q.type === 'image_upload') {
                document.querySelectorAll('.upload-box').forEach((box, i) => { const img = box.querySelector('img'); if (img) state.values[i] = { val: img.src }; });
            } else {
                document.querySelectorAll('.slot').forEach(slot => { const item = slot.querySelector('.macaron-btn'); if (item) state.values[slot.dataset.index] = { elId: item.id, val: item.dataset.value }; });
            }
            userStates[currentIdx] = state;
        }

        function restoreCurrentQuestionState() {
            const state = userStates[currentIdx]; if (!state) return;
            const q = quizData[currentIdx];
            if (q.type === 'image_upload') {
                Object.keys(state.values).forEach(idx => { const box = document.getElementById(`upload-${idx}`); if (box) box.innerHTML = `<img src="${state.values[idx].val}" alt="screenshot"><div class="upload-label">${q.labels[idx]}</div>`; });
            } else {
                Object.keys(state.values).forEach(slotIdx => { const elId = state.values[slotIdx].elId; const el = document.getElementById(elId); const slot = document.querySelector(`.slot[data-index="${slotIdx}"]`); if (el && slot) slot.appendChild(el); });
            }
        }

        function navigate(dir) {
            saveCurrentQuestionState();
            if (currentIdx === 0 && dir === 1) { showPwModal(() => performNavigation(dir)); return; }
            if (dir > 0 && !quizCheckedStatus[currentIdx]) {
                if (currentIdx + dir < quizData.length) { 
                    showCustomModal("æº«é¦¨æé†’", "å¾…æœƒè¦è¨˜å¾—å›ä¾†æŒ‰ä¸‹æª¢æŸ¥ç­”æ¡ˆå–”ï¼", "å‰å¾€ä¸‹ä¸€é¡Œ", () => performNavigation(dir)); 
                    return; 
                } else { 
                    const unchecked = []; for (let i = 0; i < quizData.length; i++) if (!quizCheckedStatus[i]) unchecked.push(i + 1); 
                    if (unchecked.length > 0) { showCustomModal("æº«é¦¨æé†’", `ç¬¬ ${unchecked.join('ã€')} é¡Œå¿˜è¨˜æª¢æŸ¥å›‰ï¼`, "æŸ¥çœ‹çµæœ", () => performNavigation(dir)); return; } 
                }
            }
            performNavigation(dir);
        }

        function performNavigation(dir) {
            if (currentIdx + dir >= quizData.length) { showFinalSummary(); return; }
            currentIdx += dir; renderQuestion();
        }

        function checkAnswer() {
            quizCheckedStatus[currentIdx] = true; 
            totalAttempts++; 
            const q = quizData[currentIdx];
            let errors = 0; let incomplete = false;
            
            if (q.type === 'image_upload') {
                const imgs = [];
                document.querySelectorAll('.upload-box').forEach(box => { 
                    const img = box.querySelector('img');
                    if (!img) incomplete = true; else imgs.push(img.src);
                });
                if (!incomplete) {
                    const uniqueImgs = new Set(imgs);
                    if (uniqueImgs.size < imgs.length) { showToast("ç™¼ç¾é‡è¤‡æˆªåœ–ï¼è«‹æ›´æ›å…§å®¹å–”ã€‚", "error"); return; }
                }
            } else {
                document.querySelectorAll('.slot').forEach(slot => { const item = slot.querySelector('.macaron-btn'); if (!item) incomplete = true; if (item && item.dataset.value !== slot.dataset.answer) errors++; });
            }

            if (incomplete) { showToast("è«‹å°‡æ‰€æœ‰å…§å®¹å¡«å®Œ/è²¼å®Œå–”ï¼", "error"); return; }
            if (errors === 0) {
                showToast("ğŸ‰ å¤ªæ£’äº†ï¼å…¨éƒ¨æ­£ç¢ºï¼", "success");
                quizPassedStatus[currentIdx] = true;
                updateProgressIndicators();
                if(currentIdx === 0) document.getElementById('next-btn').disabled = false;
            } else { showToast(`é‚„å·®ä¸€é»é»ï¼é‚„æœ‰ ${errors} å€‹éŒ¯èª¤å–”ã€‚`, "error"); }
        }

        function updateProgressIndicators() {
            document.querySelectorAll('.progress-circle').forEach(circle => { if (quizPassedStatus[parseInt(circle.dataset.idx)]) circle.classList.add('passed'); });
        }

        function useFirstAid(aidElement) {
            // æŒ‡ä»¤ï¼šç¬¬ä¸€é¡Œæ‡‰ç”Ÿæ•ˆ
            if (firstAidCount <= 0 || aidElement.style.opacity === "0.2") return;

            // å¯¦ä½œé¡Œä½¿ç”¨æ€¥æ•‘åŒ…çš„è¦–è¦ºæç¤ºï¼ˆåƒ…å±•ç¤ºæ•ˆæœï¼Œå› å¯¦ä½œé¡Œç„¡æ¨™æº–ç­”æ¡ˆé…å°ï¼‰
            if (currentIdx === 0) {
                showToast("âœ¨ æ€¥æ•‘åŒ…å·²å•Ÿå‹•ï¼è«‹ç¢ºèªå››å¼µæˆªåœ–çš†å·²æ­£ç¢ºè²¼ä¸Šã€‚", "success");
            }

            aidElement.style.opacity = "0.2"; 
            aidElement.style.pointerEvents = "none";
            firstAidCount--;
            
            document.querySelectorAll('.slot').forEach(slot => { 
                const item = slot.querySelector('.macaron-btn'); 
                if (item?.dataset.value === slot.dataset.answer) slot.classList.add('correct-hint'); 
                else slot.classList.add('error-hint'); 
                setTimeout(() => slot.classList.remove('correct-hint', 'error-hint'), 2000); 
            });
        }

        function showToast(msg, type) {
            const toast = document.getElementById('toast'); toast.innerText = msg;
            toast.className = `fixed bottom-10 left-1/2 -translate-x-1/2 px-8 py-4 rounded-full text-white font-bold transition-all z-[600] text-xl shadow-lg ${type === 'success' ? 'bg-green-500' : 'bg-gray-800'}`;
            toast.style.opacity = "1"; setTimeout(() => toast.style.opacity = "0", 3000);
        }

        function restartQuiz() {
            document.getElementById('result-overlay').classList.add('hidden');
            for (let i = 1; i < quizData.length; i++) { delete userStates[i]; delete quizCheckedStatus[i]; delete quizPassedStatus[i]; }
            
            firstAidCount = 2;
            const aidKit = document.getElementById('aid-kit');
            aidKit.classList.remove('aid-kit-disabled');
            aidKit.classList.add('aid-kit-enabled');
            document.querySelectorAll('.first-aid').forEach(aid => { aid.style.opacity = "1"; aid.style.pointerEvents = "auto"; aid.style.cursor = "pointer"; });

            totalAttempts = 0; isTimerStarted = false;
            if (timerInterval) clearInterval(timerInterval);
            document.getElementById('timer').innerText = "00:00";
            document.querySelectorAll('.progress-circle').forEach(circle => { if (parseInt(circle.dataset.idx) > 0) circle.classList.remove('passed'); });

            currentIdx = 1; 
            renderQuestion();
            startTimer(); 
        }

        function showFinalSummary() {
            if (timerInterval) clearInterval(timerInterval);
            saveCurrentQuestionState();
            const screenshotArea = document.getElementById('summary-screenshots');
            const timerText = document.getElementById('timer').innerText;
            screenshotArea.innerHTML = '';
            const imgState = userStates[0];
            if (imgState && imgState.values) {
                Object.keys(imgState.values).forEach(idx => {
                    const label = quizData[0].labels[idx];
                    screenshotArea.innerHTML += `<div class="flex flex-col items-center"><span class="text-xs font-bold text-gray-500 mb-1">${label}</span><div class="border rounded-lg overflow-hidden bg-gray-5 aspect-square shadow-sm w-full"><img src="${imgState.values[idx].val}" class="w-full h-full object-cover"></div></div>`;
                });
            }
            let correctCount = 0; quizData.forEach((_, idx) => { if (quizPassedStatus[idx]) correctCount++; });
            const randomQuote = inspirationalQuotes[Math.floor(Math.random() * inspirationalQuotes.length)];
            document.getElementById('quote-zh').innerText = randomQuote.zh; document.getElementById('quote-en').innerText = randomQuote.en;
            const stats = document.getElementById('final-stats');
            stats.innerHTML = `<div class="grid grid-cols-2 gap-6"><div class="bg-pink-50 p-6 rounded-2xl text-center border border-pink-100 shadow-sm"><p class="text-lg text-pink-400 font-bold uppercase tracking-tight">ç¸½é¡Œæ•¸</p><p class="text-4xl font-black text-pink-600">${quizData.length}</p></div><div class="bg-green-50 p-6 rounded-2xl text-center border border-green-100 shadow-sm"><p class="text-lg text-green-400 font-bold uppercase tracking-tight">ç­”å°é¡Œæ•¸</p><p class="text-4xl font-black text-green-600">${correctCount}</p></div></div><div class="text-center p-6 bg-white/50 rounded-2xl"><p class="text-2xl font-bold text-gray-700 mb-3 text-balance">æŒ‘æˆ°å®Œæˆï¼</p><p class="text-lg text-gray-500">æ¸¬é©—ç¸½ç”¨æ™‚ï¼š<span class="text-indigo-500 font-bold">${timerText}</span> | æª¢æŸ¥æ¬¡æ•¸ï¼š<span class="text-indigo-500 font-bold">${totalAttempts}</span></p></div>`;
            document.getElementById('result-overlay').classList.remove('hidden');
        }
    </script>
</body>
</html>